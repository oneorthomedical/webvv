!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t){e.exports={fps:30,interpolation:0,interpolationNM:0,autoIntensity:!1,bgColor:16711680,rightClickAllowed:!1,zoomSpeed:1.1,zoomInIsWheelDown:!0,stackTopIsWheelDown:!0,zoomIn:"+",zoomIn2:"i",zoomOut:"-",zoomOut2:"o",zoomHold:17,stackUp:"ArrowUp",stackDown:"ArrowDown",mouseClickProbe:1,mouseClickPan:2,mouseClickWindow:3,resetCamera:"r"}},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});class o{static uniforms(){return{uTextureBackground:{type:"t",value:[],typeGLSL:"sampler2D"},uTextureFusion:{type:"t",value:[],typeGLSL:"sampler2D"},uOpacityMin:{type:"f",value:1,typeGLSL:"float"},uOpacityMax:{type:"f",value:1,typeGLSL:"float"},uThreshold:{type:"f",value:.01,typeGLSL:"float"},uUseFusion:{type:"b",value:!0,typeGLSL:"bool"},uTextureOverlay:{type:"t",value:[],typeGLSL:"sampler2D"},uUseOverlay:{type:"b",value:!0,typeGLSL:"bool"}}}}},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return o});class o{constructor(e){this._uniforms=e,this._functions={},this._main=""}functions(){""===this._main&&this.main();let e="";for(let t in this._functions)e+=this._functions[t]+"\n";return e}uniforms(){let e="";for(let t in this._uniforms){let n=this._uniforms[t];e+=`uniform ${n.typeGLSL} ${t}`,n&&n.length&&(e+=`[${n.length}]`),e+=";\n"}return e}main(){this._main="\nvoid main(void) {\n\n  vec2 texc = vec2(((vProjectedCoords.x / vProjectedCoords.w) + 1.0 ) / 2.0,\n                ((vProjectedCoords.y / vProjectedCoords.w) + 1.0 ) / 2.0 );\n\n  // just silence warning for\n  // vec4 dummy = vPos;\n\n  //The back position is the world space position stored in the texture.\n  vec4 baseColorBG = texture2D(uTextureBackground, texc);\n  vec4 baseColorFusion = texture2D(uTextureFusion, texc);\n\n  if(!uUseFusion || baseColorFusion.w < uThreshold){\n    gl_FragColor = baseColorBG;\n  }else{\n    gl_FragColor = mix( baseColorBG, baseColorFusion, uOpacityMin+uOpacityMax*baseColorFusion.w);\n  }\n  return;\n}\n   "}compute(){return`\n// uniforms\n${this.uniforms()}\n\n// varying (should fetch it from vertex directly)\n// varying vec4      vPos;\nvarying vec4      vProjectedCoords;\n\n// tailored functions\n${this.functions()}\n\n// main loop\n${this._main}\n      `}}},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return a});const o=n(2),i=n(1),r=n(0);class a{constructor(e){let t=[0,0,0,0,0,0];this.worldBB=t,this.uniforms={};let n,a,s,u,l=this,c=e,d={background:null,fusion:null,overlay:null,struct:[]},m={background:null,fusion:null,overlay:null,struct:[]},h={background:null,fusion:null,overlay:null,struct:[]},f={background:null,fusion:null,overlay:null,struct:[]},p={background:null,fusion:null,overlay:null,struct:[]};function g(){l.uniformsMix.uTextureBackground.value=h.background.texture,null!==h.fusion&&(l.uniformsMix.uTextureFusion.value=h.fusion.texture),null!==h.overlay&&(l.uniformsMix.uTextureOverlay.value=h.overlay.texture),l.uniformsMix.uOpacityMin.value=.1,l.uniformsMix.uOpacityMax.value=.8,l.uniformsMix.uThreshold.value=.01}function v(){!function(){null!==h.fusion&&(f.fusion.geometry.dispose(),f.fusion.geometry=n.slice.geometry,f.fusion.geometry.verticesNeedUpdate=!0),null!==h.overlay&&(f.overlay.geometry.dispose(),f.overlay.geometry=n.slice.geometry,f.overlay.geometry.verticesNeedUpdate=!0);for(let e of f.struct)e.geometry.dispose(),e.geometry=n.slice.geometry,e.geometry.verticesNeedUpdate=!0}(),a.remove(u),u.material.dispose(),u.geometry.dispose(),(u=new THREE.Mesh(n.slice.geometry,s)).applyMatrix(n.stack._ijk2LPS),a.add(u)}function w(e){for(let n=0;n<t.length;n++)n%2==0?e[n]<t[n]&&(t[n]=e[n]):e[n]>t[n]&&(t[n]=e[n])}d.background=new THREE.Scene,m.background=new AMI.LutHelper("my-lut-canvases","default","linear",[[0,0,0,0],[0,1,1,1]],[[0,1],[1,1]]),m.background.luts=AMI.LutHelper.presetLuts(),m.background.lut="default",h.background=new THREE.WebGLRenderTarget(c.clientWidth,c.clientHeight,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),h.background.setSize(c.clientWidth,c.clientHeight),this.resize=function(){h.background.setSize(c.clientWidth,c.clientHeight),null!==h.fusion&&h.fusion.setSize(c.clientWidth,c.clientHeight),null!==h.overlay&&h.overlay.setSize(c.clientWidth,c.clientHeight);for(let e of h.struct)e.setSize(c.clientWidth,c.clientHeight)},this.render=function(e,t){v(),e.render(d.background,t,h.background,!0),null!==h.fusion&&e.render(d.fusion,t,h.fusion,!0),null!==h.overlay&&e.render(d.overlay,t,h.overlay,!0);for(let n=0;n<h.struct.length;n++)e.render(d.struct[n],t,h.struct[n],!0);e.render(a,t)},this.setMainStackHelper=function(e){(n=e).slice.intensityAuto=r.autoIntensity,n.slice.interpolation=r.interpolation,n.slice.lut=m.background,n.slice.lutTexture=m.background.texture,d.background.add(n),w(n._stack.worldBoundingBox()),function(){a=new THREE.Scene,l.uniformsMix=i.default.uniforms(),g();let e=new o.default(l.uniformsMix),t=new AMI.LayerVertexShader,r=new THREE.ShaderMaterial({side:THREE.FrontSide,uniforms:l.uniformsMix,vertexShader:t.compute(),fragmentShader:e.compute(),transparent:!0});s=r;let c=new THREE.Mesh(n.slice.geometry,r);u=c,c.applyMatrix(n.stack._ijk2LPS),a.add(c),v()}()},this.addLayer=function(e,t){if("fusion"!=t&&"overlay"!=t)return;let o=new THREE.Scene;d[t]=o;let i=new AMI.LutHelper("my-lut-canvases","default","linear",[[0,0,0,0],[1,1,1,1]],[[0,0],[1,1]]);i.luts=AMI.LutHelper.presetLuts(),m[t]=i,i.lut="blue";let a=new THREE.WebGLRenderTarget(c.clientWidth,c.clientHeight,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});a.setSize(c.clientWidth,c.clientHeight),h[t]=a,e.prepare(),e.pack();let s=[];for(let t=0;t<e._rawData.length;t++){let n=new THREE.DataTexture(e.rawData[t],e.textureSize,e.textureSize,e.textureType,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);n.needsUpdate=!0,n.flipY=!0,s.push(n)}let u=AMI.DataUniformShader.uniforms();u.uTextureSize.value=e.textureSize,u.uTextureContainer.value=s,u.uWorldToData.value=e.lps2IJK,u.uNumberOfChannels.value=e.numberOfChannels,u.uBitsAllocated.value=e.bitsAllocated,u.uPackedPerPixel.value=e.packedPerPixel,u.uWindowCenterWidth.value=[e.windowCenter,e.windowWidth],u.uRescaleSlopeIntercept.value=[e.rescaleSlope,e.rescaleIntercept],u.uDataDimensions.value=[e.dimensionsIJK.x,e.dimensionsIJK.y,e.dimensionsIJK.z],u.uInterpolation.value=r.interpolationNM;let v=0;e._minMax[0]<0&&(v-=e._minMax[0]),u.uLowerUpperThreshold.value=[e.minMax[0]+v,e.minMax[1]+v],u.uLut.value=1,u.uTextureLUT.value=i.texture,l.uniforms[t]=u;let y=new AMI.DataFragmentShader(u),x=new AMI.DataVertexShader,E=new THREE.ShaderMaterial({side:THREE.FrontSide,uniforms:u,vertexShader:x.compute(),fragmentShader:y.compute()}),C=new THREE.Mesh(n.slice.geometry,E);f[t]=C,C.applyMatrix(n.stack._ijk2LPS);let b=n._stack.worldCenter().clone();b.sub(e.worldCenter()),C.translateX(b.x),C.translateY(b.y),C.translateZ(b.z),p[t]=b,o.add(C),w(e.worldBoundingBox()),g()}}}},function(e,t,n){"use strict";n.r(t),n.d(t,"default",function(){return i});const o=n(0);class i extends THREE.EventDispatcher{constructor(e,t,n,i){super();let r=this,a=i,s={NONE:0,SETPROB:1,PAN:2,WINDOW:3},u=new Map,l=(s.NONE,new THREE.Vector2),c=new THREE.Vector2,d=new THREE.Vector3,m=new THREE.Vector3;function h(e){switch(e.key){case o.zoomIn:case o.zoomIn2:r.zoom(!0);break;case o.zoomOut:case o.zoomOut2:r.zoom(!1);break;case o.resetCamera:r.reset()}}function f(e){switch(u.set(e.keyCode,!0),e.key){case"Escape":r._state=s.NONE;break;case o.stackUp:r.scrollStack(!0);break;case o.stackDown:r.scrollStack(!1)}}function p(e){u.set(e.keyCode,!1)}function g(e){switch(e.which){case o.mouseClickProbe:r._state=s.SETPROB;break;case o.mouseClickPan:r._state=s.PAN,e.preventDefault();break;case o.mouseClickWindow:r._state=s.WINDOW}l.x=e.clientX,l.y=e.clientY,document.addEventListener("mousemove",w,!1)}function v(e){r._state=s.NONE,document.removeEventListener("mousemove",w,!1)}function w(e){switch(c.x=e.clientX,c.y=e.clientY,r._state){case s.PAN:r.pan(l,c);break;case s.SETPROB:case s.WINDOW:}l=c,c=new THREE.Vector2}function y(e){var t;t=o.zoomHold,u.has(t)&&u.get(t)?(r.zoom(e.deltaY>0===o.zoomInIsWheelDown),e.preventDefault()):(r.scrollStack(e.deltaY>0===o.stackTopIsWheelDown),e.preventDefault())}function x(e){o.rightClickAllowed||e.preventDefault()}this.camera=e,this.stack=t,this.domElement=void 0!==n?n:document,this.target=new THREE.Vector3,this.noZoom=!1,this.noPan=!1,this.noRotate=!0,this.handleResize=function(){},this.update=function(){r._changed&&r.camera.updateProjectionMatrix(),this.camera.lookAt(this.target)},this.setAsResetState=function(){},this.reset=function(){a.hasChanged=!0},this.pan=function(e,t){if(d.subVectors(r.camera.position,r.target),this.noPan)return;let o=t.x-e.x,i=t.y-e.y;o/=n.offsetWidth,i/=n.offsetHeight,o*=(r.camera.right-r.camera.left)/r.camera.zoom,i*=(r.camera.top-r.camera.bottom)/r.camera.zoom;let s=new THREE.Vector3;s.copy(r.camera.up).setLength(i),s.add(m.copy(d).cross(r.camera.up).setLength(o)),r.camera.position.add(s),r.target.add(s),r._changed=!0,a.hasChanged=!0},this.zoom=function(e){if(this.noZoom)return;let t=e?1/o.zoomSpeed:o.zoomSpeed;Math.abs(t-1)>1e-6&&t>0&&(this.camera.zoom/=t,a.hasChanged=!0)},this.scrollStack=function(e){if(e){if(t.index>=t.orientationMaxIndex-1)return!1;t.index+=1}else{if(t.index<=0)return!1;t.index-=1}a.hasChanged=!0},this.dispose=function(){document.removeEventListener("mousedown",g,!1),document.removeEventListener("mouseup",v,!1),document.removeEventListener("wheel",y,!1),document.removeEventListener("contextmenu",x,!1),document.removeEventListener("keypress",h,!1),document.removeEventListener("keyup",p,!1),document.removeEventListener("keydown",f,!1)},document.addEventListener("mousedown",g,!1),document.addEventListener("mouseup",v,!1),document.addEventListener("wheel",y,!1),document.addEventListener("contextmenu",x,!1),document.addEventListener("keypress",h,!1),document.addEventListener("keyup",p,!1),document.addEventListener("keydown",f,!1),this.camera.position.z=1,this.handleResize(),this.update(),this.setAsResetState()}}},function(e,t){e.exports=function(){function e(e,t){"CR"!==t&&"DX"!==t&&(document.getElementById("top").innerHTML=e[0],document.getElementById("bottom").innerHTML=e[1],document.getElementById("right").innerHTML=e[2],document.getElementById("left").innerHTML=e[3])}return{buildGUI:function(t,n,o){let i=t._stack,r=new dat.GUI({autoPlace:!1}),a={invertRows:!1,invertColumns:!1,rotate:!1,orientation:"default",convention:"radio"};document.getElementById("my-gui-container").appendChild(r.domElement);let s=r.addFolder("Stack");s.add(t.slice,"windowWidth",1,i.minMax[1]-i.minMax[0]).step(1).listen().onChange(e=>{o.hasChanged=!0}),s.add(t.slice,"windowCenter",i.minMax[0],i.minMax[1]).step(1).listen().onChange(e=>{o.hasChanged=!0}),s.add(t.slice,"invert").onChange(e=>{o.hasChanged=!0}),lut=new AMI.LutHelper("my-lut-canvases","default","linear",[[0,0,0,0],[1,1,1,1]],[[0,1],[1,1]]),lut.luts=AMI.LutHelper.presetLuts(),s.add(t.slice,"lut",lut.lutsAvailable()).onChange(function(e){lut.lut=e,t.slice.lutTexture=lut.texture,o.hasChanged=!0}),s.add(lut,"discrete",!1).onChange(function(e){lut.discrete=e,t.slice.lutTexture=lut.texture,o.hasChanged=!0});let u=s.add(t,"index",0,i.dimensionsIJK.z-1).step(1).listen().onChange(e=>{o.hasChanged=!0});s.open();let l=r.addFolder("Camera");l.add(a,"invertRows").onChange(function(){n.invertRows(),e(n.directionsLabel,i.modality)}),l.add(a,"invertColumns").onChange(function(){n.invertColumns(),e(n.directionsLabel,i.modality)}),l.add(n,"angle",0,360).step(1).listen().onChange(function(){e(n.directionsLabel,i.modality),o.hasChanged=!0}),l.add(a,"rotate").onChange(function(){n.rotate(),e(n.directionsLabel,i.modality),o.hasChanged=!0}),l.add(a,"orientation",["default","axial","coronal","sagittal"]).onChange(function(r){n.orientation=r,n.update(),n.fitBox(2),t.orientation=n.stackOrientation,e(n.directionsLabel,i.modality),u.__max=t.orientationMaxIndex,t.index=Math.floor(u.__max/2),o.hasChanged=!0}),l.add(a,"convention",["radio","neuro"]).onChange(function(t){n.convention=t,n.update(),n.fitBox(2),e(n.directionsLabel,i.modality),o.hasChanged=!0})},updateLabels:e}}()},function(e,t){e.exports=function(){let e,t,n,o,i,r;function a(){n=Date.now(),(i=n-o)>e&&(o=n-i%e,r()),requestAnimationFrame(a)}return{startAnimating:function(n,i){r=i,imgHasChanged=!0,e=1e3/n,o=Date.now(),t=o,a()}}}()},function(e,t){e.exports=function(){function e(e,t){return t.extension.toUpperCase()===e.toUpperCase()}function t(e){return new Promise((t,n)=>{const o=new XMLHttpRequest;o.responseType="blob",o.onload=(()=>{"200"==o.status?t(o.response):n(o.statusText)}),o.onerror=(()=>n(o.statusText)),o.open("GET",e),o.send()})}return{readMultipleFiles:function(n,o){let i,r={},a={};var s;function u(o,i,a){return new Promise((s,u)=>{Promise.resolve().then(e=>{if(void 0!==o[a])return console.log(a+" : Files request..."),function(e,n,o){return new Promise((i,r)=>{e[o]||r("No category with this name ("+o+") in json.");let a=Promise.resolve(),s=[];for(let n=0;n<e[o].length;n++)a=a.then(i=>t("/datafiles/"+e.study+"/"+e[o][n])).then(t=>{e[o][n].split("/").pop(),s.push(new File([t],e[o][n].split("/").pop()))});a=a.then(e=>{n[o]=s,i()})})}(o,i,a)}).then(t=>{if(void 0!==o[a])return console.log(a+" : Files loading..."),function(t,o){return new Promise((i,a)=>{const s=[],u=[],c={};let d;for(let n=0;n<t[o].length;n++){let i=AMI.UtilsCore.parseUrl(t[o][n].name);e("mhd",i)?(c.header=t[o][n],d=!0):e("raw",i)?c.data=t[o][n]:u.push(t[o][n])}if(void 0!==d)void 0===c.header||void 0===c.data?a("Data seems to be 'header (mhd) + data (raw)' but data can't be found !"):s.push(function(e,t){const o=[];for(let t in e)o.push(new Promise((n,o)=>{const i=new FileReader;i.onload=(e=>{n(e.target.result)}),i.readAsArrayBuffer(e[t])}).then(function(n){return{url:e[t].name,buffer:n}}));return Promise.all(o).then(e=>n.parse(e)).then(function(e){r[t]=[],r[t].push(e)}).catch(function(e){window.console.log("oops... something went wrong while parsing the sequence..."),window.console.log(e)})}(c,o));else for(let e=0;e<u.length;e++)s.push(l(e,u,o));Promise.all(s).then(function(){i(r)}).catch(function(e){window.console.log(e),a("oops... something went wrong while using the sequence...")})})}(i,a)}).then(e=>{s()})})}function l(e,t,o){return Promise.resolve().then(function(){return new Promise(function(n,o){const i=new FileReader;i.addEventListener("load",function(e){n(e.target.result)}),i.readAsArrayBuffer(t[e])})}).then(function(o){return n.parse({url:t[e].name,buffer:o})}).then(function(e){r[o]=[],r[o].push(e)}).catch(function(e){window.console.log("Oops... something went wrong while loading the sequence..."),window.console.log(e)})}Promise.resolve().then(e=>{console.log("Json request...");const t="/"+function(){let e=[],t=window.location.search.substring(1).split("&");for(let n=0,o=t.length;n<o;n++){if(""===t[n])continue;let o=t[n].split("=");"viewer"===decodeURIComponent(o[0])&&(e[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||""))}return e}().viewer;return s=t,new Promise((e,t)=>{const n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.onload=(()=>{"200"==n.status?e(n.responseText):t(n.statusText)}),n.onerror=(()=>t(n.statusText)),n.open("GET",s),n.send()})}).then(e=>{i=JSON.parse(e)}).then(e=>u(i,a,"image")).then(e=>u(i,a,"fusion")).then(e=>{console.log("Files loaded."),o(r)}).catch(e=>{console.log("An error has occured:"),console.log(e)})}}}()},function(e,t,n){const o=n(0),i=n(7),r=n(6),a=n(5),s=n(4),u=n(3);let l,c,d,m,h,f,p,g={hasChanged:!0};window.onload=function(){c=document.getElementById("r3d"),(l=new THREE.WebGLRenderer({antialias:1==o.interpolation})).setSize(c.offsetWidth,c.offsetHeight),l.setClearColor(o.bgColor,1),l.setPixelRatio(window.devicePixelRatio),c.appendChild(l.domElement),d=new Stats,c.appendChild(d.domElement),m=new u.default(c),f=new AMI.OrthographicCamera(c.clientWidth/-2,c.clientWidth/2,c.clientHeight/2,c.clientHeight/-2,.1,1e4);let e=new AMI.VolumeLoader(c);function t(){f.canvas={width:c.offsetWidth,height:c.offsetHeight},l.setSize(c.offsetWidth,c.offsetHeight),m.resize()}i.readMultipleFiles(e,function(n){e.free(),e=null;let i=n.image[0].mergeSeries(n.image)[0].stack[0],u=n.fusion[0].mergeSeries(n.fusion)[0].stack[0];(h=new AMI.StackHelper(i)).bbox.visible=!1,h.border.visible=!1,m.setMainStackHelper(h),m.addLayer(u,"fusion"),p=new s.default(f,h,c,g),f.controls=p;let v=m.worldBB,w=new THREE.Vector3((v[1]-v[0])/2,(v[3]-v[2])/2,(v[5]-v[4])/2),y={center:i.worldCenter().clone(),halfDimensions:new THREE.Vector3(w.x+100,w.y+100,w.z+100)},x={width:c.clientWidth,height:c.clientHeight};f.directions=[i.xCosine,i.yCosine,i.zCosine],f.box=y,f.canvas=x,f.update(),f.fitBox(2),a.updateLabels(f.directionsLabel,i.modality),a.buildGUI(h,f,g),window.addEventListener("resize",t,!1),t(),r.startAnimating(o.fps,function(){p.update(),g.hasChanged&&(m.render(l,f),g.hasChanged=!1),d.update()})})}}]);